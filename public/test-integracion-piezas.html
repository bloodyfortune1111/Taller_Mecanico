<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba Integraci√≥n API Piezas</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .result { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .warning { background: #fff3e0; color: #f57c00; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .test-section { border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
        select, input { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .pieza-item { 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin: 5px 0; 
            border-radius: 5px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .pieza-item.selected { background: #e3f2fd; border-color: #2196f3; }
        .pieza-item.no-stock { background: #ffebee; color: #666; }
        .pieza-info { flex: 1; }
        .pieza-precio { font-weight: bold; color: #2e7d32; }
        .pieza-stock { font-size: 0.9em; color: #666; }
        .lista-seleccionadas { background: #f9f9f9; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .total { font-size: 1.2em; font-weight: bold; color: #2e7d32; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Prueba de Integraci√≥n - API de Piezas</h1>
        
        <div class="grid">
            <!-- Secci√≥n 1: Cargar Piezas -->
            <div class="test-section">
                <h3>üìã 1. Cargar Piezas</h3>
                <button onclick="cargarTodasPiezas()">Cargar Todas las Piezas</button>
                <div id="resultado-carga"></div>
            </div>
            
            <!-- Secci√≥n 2: Filtrar por Categor√≠a -->
            <div class="test-section">
                <h3>üîç 2. Filtrar por Categor√≠a</h3>
                <select id="categoria-filter" onchange="filtrarPorCategoria()">
                    <option value="">Todas las categor√≠as</option>
                </select>
                <div id="resultado-filtro"></div>
            </div>
            
            <!-- Secci√≥n 3: Simulaci√≥n de Select -->
            <div class="test-section">
                <h3>üéØ 3. Simulaci√≥n de Select</h3>
                <select id="pieza-select" onchange="mostrarDetallesPieza()">
                    <option value="">Seleccione una pieza</option>
                </select>
                <div id="detalles-pieza"></div>
            </div>
            
            <!-- Secci√≥n 4: Carrito de Piezas -->
            <div class="test-section">
                <h3>üõí 4. Carrito de Piezas</h3>
                <div>
                    <input type="number" id="cantidad-pieza" value="1" min="1" max="10">
                    <button onclick="agregarPiezaAlCarrito()">Agregar al Carrito</button>
                </div>
                <div class="lista-seleccionadas">
                    <h4>Piezas Seleccionadas:</h4>
                    <div id="lista-carrito"></div>
                    <div class="total">Total: $<span id="total-carrito">0.00</span></div>
                </div>
            </div>
        </div>
        
        <!-- Secci√≥n de Logs -->
        <div class="test-section">
            <h3>üìã Log de Pruebas</h3>
            <button onclick="limpiarLogs()">Limpiar Logs</button>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let piezasDisponibles = [];
        let piezasEnCarrito = [];
        let categorias = [];
        
        // Funci√≥n para agregar logs
        function agregarLog(mensaje, tipo = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const cssClass = tipo === 'error' ? 'error' : tipo === 'success' ? 'success' : 'result';
            
            logsDiv.innerHTML += `
                <div class="result ${cssClass}">
                    <strong>[${timestamp}]</strong> ${mensaje}
                </div>
            `;
            
            // Scroll hacia abajo
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function limpiarLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        // 1. Cargar todas las piezas
        async function cargarTodasPiezas() {
            try {
                agregarLog('Cargando todas las piezas...');
                
                const response = await fetch('/api/piezas-taller/');
                const data = await response.json();
                
                if (data.success) {
                    piezasDisponibles = data.data;
                    
                    document.getElementById('resultado-carga').innerHTML = `
                        <div class="result success">
                            ‚úÖ Cargadas ${piezasDisponibles.length} piezas
                        </div>
                    `;
                    
                    // Actualizar el select
                    actualizarSelectPiezas(piezasDisponibles);
                    
                    // Cargar categor√≠as
                    await cargarCategorias();
                    
                    agregarLog(`Cargadas ${piezasDisponibles.length} piezas correctamente`, 'success');
                } else {
                    throw new Error(data.message || 'Error desconocido');
                }
            } catch (error) {
                const errorMsg = `Error al cargar piezas: ${error.message}`;
                document.getElementById('resultado-carga').innerHTML = `
                    <div class="result error">‚ùå ${errorMsg}</div>
                `;
                agregarLog(errorMsg, 'error');
            }
        }
        
        // 2. Cargar categor√≠as
        async function cargarCategorias() {
            try {
                const response = await fetch('/api/piezas-taller/categorias');
                const data = await response.json();
                
                if (data.success) {
                    categorias = data.data;
                    
                    const select = document.getElementById('categoria-filter');
                    select.innerHTML = '<option value="">Todas las categor√≠as</option>';
                    
                    categorias.forEach(categoria => {
                        const option = document.createElement('option');
                        option.value = categoria;
                        option.textContent = categoria;
                        select.appendChild(option);
                    });
                    
                    agregarLog(`Cargadas ${categorias.length} categor√≠as`);
                }
            } catch (error) {
                agregarLog(`Error al cargar categor√≠as: ${error.message}`, 'error');
            }
        }
        
        // 3. Filtrar por categor√≠a
        async function filtrarPorCategoria() {
            const categoria = document.getElementById('categoria-filter').value;
            
            try {
                agregarLog(`Filtrando por categor√≠a: ${categoria || 'Todas'}`);
                
                const url = categoria ? 
                    `/api/piezas-taller/categoria?categoria=${encodeURIComponent(categoria)}` : 
                    '/api/piezas-taller/';
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    const piezasFiltradas = data.data;
                    
                    document.getElementById('resultado-filtro').innerHTML = `
                        <div class="result success">
                            ‚úÖ Encontradas ${piezasFiltradas.length} piezas
                        </div>
                    `;
                    
                    // Actualizar el select
                    actualizarSelectPiezas(piezasFiltradas);
                    
                    agregarLog(`Filtro aplicado: ${piezasFiltradas.length} piezas encontradas`, 'success');
                } else {
                    throw new Error(data.message || 'Error al filtrar');
                }
            } catch (error) {
                const errorMsg = `Error al filtrar: ${error.message}`;
                document.getElementById('resultado-filtro').innerHTML = `
                    <div class="result error">‚ùå ${errorMsg}</div>
                `;
                agregarLog(errorMsg, 'error');
            }
        }
        
        // 4. Actualizar select de piezas
        function actualizarSelectPiezas(piezas) {
            const select = document.getElementById('pieza-select');
            select.innerHTML = '<option value="">Seleccione una pieza</option>';
            
            if (piezas.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No se encontraron piezas';
                option.disabled = true;
                select.appendChild(option);
                return;
            }
            
            piezas.forEach(pieza => {
                const option = document.createElement('option');
                option.value = pieza.id;
                option.setAttribute('data-pieza', JSON.stringify(pieza));
                
                // Texto del option
                const stockText = pieza.stock > 0 ? `(${pieza.stock} disponible)` : '(Sin stock)';
                const disponibilidadText = pieza.disponibilidad === 'disponible' ? '' : ' - No disponible';
                
                option.textContent = `${pieza.nombre} - ${pieza.marca} - $${parseFloat(pieza.precio).toFixed(2)} ${stockText}${disponibilidadText}`;
                
                // Deshabilitar si no hay stock
                if (pieza.stock <= 0 || pieza.disponibilidad !== 'disponible') {
                    option.disabled = true;
                    option.style.color = '#999';
                }
                
                select.appendChild(option);
            });
        }
        
        // 5. Mostrar detalles de pieza seleccionada
        function mostrarDetallesPieza() {
            const select = document.getElementById('pieza-select');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                document.getElementById('detalles-pieza').innerHTML = '';
                return;
            }
            
            const pieza = JSON.parse(selectedOption.getAttribute('data-pieza'));
            
            document.getElementById('detalles-pieza').innerHTML = `
                <div class="result">
                    <h4>${pieza.nombre}</h4>
                    <p><strong>Marca:</strong> ${pieza.marca}</p>
                    <p><strong>Precio:</strong> $${parseFloat(pieza.precio).toFixed(2)}</p>
                    <p><strong>Stock:</strong> ${pieza.stock}</p>
                    <p><strong>Categor√≠a:</strong> ${pieza.categoria}</p>
                    <p><strong>Disponibilidad:</strong> ${pieza.disponibilidad}</p>
                    <p><strong>Descripci√≥n:</strong> ${pieza.descripcion}</p>
                </div>
            `;
            
            agregarLog(`Pieza seleccionada: ${pieza.nombre} - ${pieza.marca}`);
        }
        
        // 6. Agregar pieza al carrito
        function agregarPiezaAlCarrito() {
            const select = document.getElementById('pieza-select');
            const cantidadInput = document.getElementById('cantidad-pieza');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                alert('Por favor seleccione una pieza');
                return;
            }
            
            const pieza = JSON.parse(selectedOption.getAttribute('data-pieza'));
            const cantidad = parseInt(cantidadInput.value) || 1;
            
            // Validaciones
            if (pieza.stock <= 0) {
                alert('Esta pieza no tiene stock disponible');
                return;
            }
            
            if (pieza.disponibilidad !== 'disponible') {
                alert('Esta pieza no est√° disponible');
                return;
            }
            
            // Verificar si ya est√° en el carrito
            const existente = piezasEnCarrito.find(p => p.id === pieza.id);
            if (existente) {
                if (existente.cantidad + cantidad > pieza.stock) {
                    alert(`No hay suficiente stock. Disponible: ${pieza.stock}, en carrito: ${existente.cantidad}`);
                    return;
                }
                existente.cantidad += cantidad;
            } else {
                if (cantidad > pieza.stock) {
                    alert(`No hay suficiente stock. Disponible: ${pieza.stock}`);
                    return;
                }
                
                piezasEnCarrito.push({
                    id: pieza.id,
                    nombre: pieza.nombre,
                    marca: pieza.marca,
                    precio: parseFloat(pieza.precio),
                    cantidad: cantidad,
                    categoria: pieza.categoria
                });
            }
            
            // Actualizar vista del carrito
            actualizarVistaCarrito();
            
            // Limpiar selecci√≥n
            select.value = '';
            cantidadInput.value = 1;
            document.getElementById('detalles-pieza').innerHTML = '';
            
            agregarLog(`Agregada al carrito: ${pieza.nombre} x${cantidad}`, 'success');
        }
        
        // 7. Actualizar vista del carrito
        function actualizarVistaCarrito() {
            const container = document.getElementById('lista-carrito');
            const totalSpan = document.getElementById('total-carrito');
            
            if (piezasEnCarrito.length === 0) {
                container.innerHTML = '<p>No hay piezas en el carrito</p>';
                totalSpan.textContent = '0.00';
                return;
            }
            
            container.innerHTML = '';
            let total = 0;
            
            piezasEnCarrito.forEach(pieza => {
                const subtotal = pieza.precio * pieza.cantidad;
                total += subtotal;
                
                const div = document.createElement('div');
                div.className = 'pieza-item';
                div.innerHTML = `
                    <div class="pieza-info">
                        <strong>${pieza.nombre}</strong><br>
                        <small>${pieza.marca} - Cantidad: ${pieza.cantidad}</small>
                    </div>
                    <div>
                        <span class="pieza-precio">$${subtotal.toFixed(2)}</span>
                        <button onclick="eliminarDelCarrito(${pieza.id})" style="margin-left: 10px; background: #dc3545;">√ó</button>
                    </div>
                `;
                container.appendChild(div);
            });
            
            totalSpan.textContent = total.toFixed(2);
        }
        
        // 8. Eliminar del carrito
        function eliminarDelCarrito(piezaId) {
            piezasEnCarrito = piezasEnCarrito.filter(p => p.id !== piezaId);
            actualizarVistaCarrito();
            agregarLog(`Pieza eliminada del carrito`);
        }
        
        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            agregarLog('Iniciando prueba de integraci√≥n...');
            cargarTodasPiezas();
        });
    </script>
</body>
</html>
